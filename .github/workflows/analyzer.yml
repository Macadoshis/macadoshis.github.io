name: M3U analyzer
run-name: M3U analyzer (${{ inputs.streamTester || 'ffmpeg' }})

on:
  workflow_dispatch:
    inputs:
      groupsToTest:
        description: 'Number of groups to test'
        type: number
        required: true
        default: 5
      channelsToTest:
        description: 'Number of channels to test'
        type: number
        required: true
        default: 5
      retestSuccess:
        description: 'Retest succeeded.json'
        type: boolean
        required: true
        default: false
      retestFailed:
        description: 'Retest failed.json'
        type: boolean
        required: true
        default: false
      threadsCount:
        description: 'Threads'
        type: number
        required: true
        default: 5
      streamTester:
        description: 'M3U stream tester'
        type: choice
        options:
          - ffmpeg
          - http
        required: true
        default: ffmpeg
  schedule:
    - cron: '0 6 * * *'    # Runs at 06:00 UTC

#env:
#  FILE: './iptv/telegram/iptv.txt'

concurrency:
  group: analyzer-queue
  cancel-in-progress: false

jobs:
  analyzer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitHub Repo
        uses: actions/checkout@v4
      - name: Restore telegram scripts
        if: ${{ false }}
        run: |
          gpg --decrypt --batch --passphrase "${{ secrets.PGP_PWD }}" -o ./iptv/telegram/my_session.session ./iptv/telegram/my_session.session_enc
          
          [[ -f ${{ env.FILE }} ]] && rm ${{ env.FILE }}
          pip install telethon
          declare -a tge=("ariptvstalker" "StbEmucodesStalkerPortal" "+7eels9HzyOA4ZTBl")
           for tg in "${tge[@]}";
           do
            echo "Read content of t.me/$tg"
            python ./iptv/telegram/telegram-iptv-script.py t.me/$tg >> ${{ env.FILE }}
           done
      - name: Download dropbox files
        uses: gomes042/gh-actions-dropbox/files/download_zip@60f2d1f429591142b2ed6c2a22fe620b611de460
        with:
          DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
          DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
          DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
          SOURCE_PATH: /files
          DEST_PATH: ./dropbox.zip
      - name: Unzip dropbox files
        run: |
          unzip -q dropbox.zip -d dropbox
          ls -lrth dropbox/files
      - name: Clone repo and restore files
        run: |
          git clone https://github.com/Macadoshis/stalker-to-m3u.git
          
          cp dropbox/files/succeeded.json stalker-to-m3u/tools/
          cp dropbox/files/failed.json stalker-to-m3u/tools/
          cp dropbox/files/sources.txt stalker-to-m3u/tools/
          cp dropbox/files/iptv.txt stalker-to-m3u/
          cp dropbox/files/links.txt ./
      - name: Update summary
        run: |
          echo "## CURRENT content" >> $GITHUB_STEP_SUMMARY
          echo -e "| succeeded.json | failed.json    |" >> $GITHUB_STEP_SUMMARY
          echo -e "|----------------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo -e "| `jq 'length' ./stalker-to-m3u/tools/succeeded.json || echo 0`   | `jq 'length' ./stalker-to-m3u/tools/failed.json || echo 0`   |" >> $GITHUB_STEP_SUMMARY
      - name: Configure NODE
        uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.NODE_VERSION }}
      - name: Prepare stalker environment
        run: |
          cd stalker-to-m3u
          node -v
          npm -v
          npm config set loglevel info
          chmod u+x configure
          chmod u+x tools/iptv-analyzer
          # ./configure
          npm install
          sudo add-apt-repository ppa:savoury1/ffmpeg4
          # sudo apt update
          sudo apt install ffmpeg
          rm -rf ffmpeg ffprobe
          ln -s "$(which ffmpeg)" ./ffmpeg
          ln -s "$(which ffprobe)" ./ffprobe
          # sudo fallocate -l 4G /swapfile
          # sudo chmod 600 /swapfile
          # sudo mkswap /swapfile
          # sudo swapon /swapfile
          # free -h
      - name: Run analyzer
        run: |
          cd stalker-to-m3u
          tools/./iptv-analyzer --cache="true" --groupsToTest=${{ inputs.groupsToTest || 5 }} --channelsToTest=${{ inputs.channelsToTest || 5 }} --retestSuccess=${{ inputs.retestSuccess || false }} --retestFailed=${{ inputs.retestFailed || false }} --streamTester=${{ inputs.streamTester || 'ffmpeg' }} --threadsCount=${{ inputs.threadsCount || 5 }} > /dev/null 2>&1
      - name: Update summary
        run: |
          echo "## RESULT content" >> $GITHUB_STEP_SUMMARY
          echo -e "| succeeded.json | failed.json    |" >> $GITHUB_STEP_SUMMARY
          echo -e "|----------------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo -e "| `jq 'length' ./stalker-to-m3u/tools/succeeded.json || echo 0`   | `jq 'length' ./stalker-to-m3u/tools/failed.json || echo 0`   |" >> $GITHUB_STEP_SUMMARY
      - name: Save succeeded.json to dropbox
        uses: gomes042/gh-actions-dropbox/files/upload@60f2d1f429591142b2ed6c2a22fe620b611de460
        with:
          DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
          DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
          DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
          SOURCE_PATH: ./stalker-to-m3u/tools/succeeded.json
          DEST_PATH: /files/succeeded.json
      - name: Save failed.json to dropbox
        uses: gomes042/gh-actions-dropbox/files/upload@60f2d1f429591142b2ed6c2a22fe620b611de460
        with:
          DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY }}
          DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET }}
          DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN }}
          SOURCE_PATH: ./stalker-to-m3u/tools/failed.json
          DEST_PATH: /files/failed.json
      - name: Verify links
        run: |
          echo "## LINKS verification" >> $GITHUB_STEP_SUMMARY
          if [[ ! -f ./links.txt ]]; then
            echo -e "ï¸\u26A0 links.txt not found"
            exit 0
          fi
          
          while IFS= read -r link || [[ -n "$link" ]]; do
            link=$(echo "$link" | tr -d '\r')
            [[ -z "$link" ]] && continue
            response=$(curl -sL -o /dev/null -w "%{http_code}" "$link" 2>&1)
            if [ "$response" -eq 200 ]; then
              echo -e "\u2705 $link - OK" >> $GITHUB_STEP_SUMMARY
            else
              echo -e "\u274C $link - HTTP $response"
            fi
          done < ./links.txt
